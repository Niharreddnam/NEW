<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Expense & Savings Pro</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∏</text></svg>">

    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --primary: #00d2ff;
            --secondary: #3a7bd5;
            --success: #00c853;
            --danger: #ff4757;
            --warning: #f1c40f;
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.7);
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            display: block; 
            padding: 40px 20px;
        }

        body.login-mode {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wrapper {
            width: 100%;
            max-width: 1200px; 
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px;
            box-shadow: var(--glass-shadow);
            animation: fadeInUp 0.8s ease-out;
            position: relative;
            margin: 0 auto;
        }
        
        .wrapper.auth-mode { max-width: 900px; padding: 50px; }

        h1 { font-weight: 700; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        p.subtitle { color: var(--text-muted); margin-top: 0; margin-bottom: 20px; line-height: 1.6; }

        /* Inputs & Controls */
        input, select, textarea {
            width: 100%; padding: 12px 16px; background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px;
            color: #fff; font-family: 'Poppins', sans-serif; font-size: 14px; margin-bottom: 10px;
            transition: all 0.3s;
        }
        input:focus, select:focus, textarea:focus { background: rgba(255, 255, 255, 0.2); border-color: var(--primary); }
        select option { background: #333; color: #fff; }
        textarea { min-height: 300px; line-height: 1.6; resize: vertical; }

        /* Buttons */
        .btn-group { display: flex; gap: 10px; }
        button {
            padding: 12px 24px; border-radius: 50px; border: none; font-weight: 600;
            font-family: 'Poppins', sans-serif; cursor: pointer; transition: all 0.2s;
            font-size: 13px; flex: 1; text-transform: uppercase; letter-spacing: 0.5px;
        }
        button.primary { background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%); color: white; }
        button.secondary { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.1); }
        button.danger { background: linear-gradient(135deg, #ff4757 0%, #ff6b81 100%); color: white; }
        button:hover { transform: translateY(-2px); filter: brightness(1.1); }

        /* Nav */
        .nav-bar { display: none; margin-bottom: 20px; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 15px; justify-content: center; gap: 10px; }
        .nav-btn { background: transparent; border: none; color: rgba(255,255,255,0.6); padding: 10px 20px; border-radius: 10px; }
        .nav-btn.active { background: rgba(255,255,255,0.2); color: #fff; font-weight: 700; }

        /* Dashboard Structure */
        .view-section { display: none; animation: fadeInUp 0.5s ease-out; }
        .view-section.active { display: block; }
        .dashboard-grid { display: grid; grid-template-columns: 300px 1fr 300px; gap: 20px; } 

        .card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 20px; position: relative; overflow: hidden; margin-bottom: 20px;
        }
        .card h3 { font-size: 16px; margin-top: 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-bottom: 15px; }

        /* NEW: Big Stat Boxes */
        .big-stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .stat-card {
            background: rgba(0,0,0,0.2); border-radius: 20px; padding: 20px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-label { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; }
        .stat-number { font-size: 32px; font-weight: 700; margin-top: 5px; }

        /* Badges */
        .badge-container { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; min-height: 40px; }
        .game-badge { font-size: 24px; position: relative; cursor: help; transition: transform 0.2s; }
        .game-badge:hover { transform: scale(1.2); }
        .game-badge::after {
            content: attr(title); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 5px; font-size: 10px; 
            white-space: nowrap; opacity: 0; pointer-events: none; transition: 0.2s;
        }
        .game-badge:hover::after { opacity: 1; bottom: 110%; }

        /* Advisor Box */
        .advisor-box { background: rgba(0,210,255,0.1); border-left: 4px solid var(--primary); padding: 15px; border-radius: 8px; font-size: 13px; margin-bottom: 20px; display: flex; gap: 10px; align-items: start; }
        .advisor-icon { font-size: 20px; }

        /* Progress Bars */
        .budget-item { margin-bottom: 10px; }
        .budget-header { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 3px; }
        .progress-track { background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.5s; }
        .progress-fill.warn { background: var(--warning); }
        .progress-fill.over { background: var(--danger); }

        /* List Items */
        #expenses-list { max-height: 500px; overflow-y: auto; }
        .expense-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); margin-bottom: 8px; padding: 10px 12px; border-radius: 10px; border-left: 3px solid var(--primary); font-size: 13px; }
        .cat-badge { background: rgba(255,255,255,0.15); padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; }

        /* Footer */
        footer { margin-top: 50px; text-align: center; font-size: 11px; color: rgba(255,255,255,0.5); padding-bottom: 10px; width: 100%; }
        footer a { color: var(--primary); text-decoration: none; }

        /* Auth Layout */
        .auth-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 40px; align-items: center; }
        .quote-box { background: rgba(255, 255, 255, 0.05); border-left: 4px solid var(--success); padding: 20px; border-radius: 0 12px 12px 0; font-style: italic; margin: 30px 0; }

        /* Toast */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); color: #fff; padding: 15px 25px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid; animation: fadeInUp 0.4s forwards; }
        .toast.success { border-color: var(--success); } .toast.error { border-color: var(--danger); }

        /* Cache banner (keeps original look) */
        #cache-banner { display: none; margin-bottom: 12px; padding: 10px 14px; border-radius: 12px; background: rgba(0,0,0,0.45); border-left: 4px solid var(--warning); color: #fff; font-size: 13px; text-align:center; }

        @media (max-width: 900px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .auth-grid { grid-template-columns: 1fr; gap: 30px; text-align: center; }
            .big-stats-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div class="wrapper auth-mode" id="main-wrapper">
    
    <div id="auth-section">
        <div class="auth-grid">
            <div style="padding-right: 10px;">
                <h1 style="font-size: 2.8em; line-height: 1.1;">Master Your <br><span style="color:var(--success)">Money</span></h1>
                <p class="subtitle">Track expenses, visualize habits, and unlock financial freedom.</p>
                <div class="quote-box">"Do not save what is left after spending, but spend what is left after saving."
                  <div style="font-size: 0.8em; margin-top: 10px; font-weight: bold;">‚Äî Warren Buffett</div>
                </div>

            </div>
            <div class="card" style="text-align: center; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <h2>Get Started</h2>
                <input id="email" type="email" placeholder="Email Address">
                <input id="password" type="password" placeholder="Password">
                <div class="btn-group" style="flex-direction: column; gap: 15px; margin-top: 10px;">
                    <button class="primary" onclick="signIn()">Login</button>
                    <button class="secondary" onclick="signUp()">Register</button>
                    <button class="secondary" onclick="showCachedFromAuthCard()">View cached history</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-content" style="display:none;">
        <!-- cache banner inserted but styled to match app -->
        <div id="cache-banner">You are viewing <strong>cached</strong> data. Log in to see live data.</div>
        
        <div style="text-align: center; margin-bottom: 10px;">
            <div class="badge-container" id="badge-case"></div>
            <h1>Expense & Savings Pro</h1>
        </div>

        <div class="nav-bar" id="main-nav" style="display:flex;">
            <button class="nav-btn active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="nav-btn" onclick="switchTab('notes')">üìù Notes</button>
            <button class="nav-btn" onclick="switchTab('comparison')">Analytics</button>
            <button class="nav-btn" onclick="switchTab('history')">üìö History</button>
            <button class="nav-btn" style="color:var(--danger)" onclick="signOut()">Logout</button>
        </div>

        <div id="view-dashboard" class="view-section active">
            
            <div class="big-stats-container">
                <div class="stat-card">
                    <div class="stat-label">Total Spent (This Month)</div>
                    <div class="stat-number text-red">‚Çπ<span id="big-spent">0</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Current Savings</div>
                    <div class="stat-number text-green">‚Çπ<span id="big-savings">0</span></div>
                </div>
            </div>

            <div class="dashboard-grid">
                
                <div>
                    <div class="card" style="padding:15px">
                        <div class="advisor-box">
                            <span class="advisor-icon">ü§ñ</span>
                            <div id="ai-advice">Loading insights...</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>‚ûï Add Transaction</h3>
                        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                            <input id="income" type="number" placeholder="Mthly Income" style="margin:0">
                            <button class="secondary" style="flex:0; padding: 10px;" onclick="updateIncome()" title="Update Income">üíæ</button>
                        </div>
                        <input id="desc" placeholder="Description">
                        <select id="category">
                            <option value="" disabled selected>Category</option>
                            <option value="Food">üçî Food</option>
                            <option value="Transport">üöó Transport</option>
                            <option value="Rent">üè† Rent</option>
                            <option value="Shopping">üõçÔ∏è Shopping</option>
                            <option value="Entertainment">üé¨ Fun</option>
                            <option value="Health">üíä Health</option>
                            <option value="Others">üì¶ Others</option>
                        </select>
                        <input id="amount" type="number" placeholder="‚Çπ Amount">
                        <button class="primary" style="width:100%" onclick="addExpense()">Add Expense</button>
                    </div>
                </div>

                <div>
                    <div class="card">
                        <h3>üìä Spending Overview</h3>
                        <div style="position: relative; height: 160px; display:flex; justify-content:center;">
                            <canvas id="expenseChart"></canvas>
                        </div>
                        <br>
                        <h3>üéØ Category Targets</h3>
                        <div id="budget-bars"></div>
                    </div>
                </div>

                <div>
                    <div class="card" style="height: 100%;">
                        <h3>üïí Activity Log</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input id="search-bar" placeholder="Search..." onkeyup="filterExpenses()" style="margin-bottom:0">
                            <button class="secondary" style="flex:0; padding:8px 12px;" onclick="exportToCSV()">üì•</button>
                        </div>
                        <div id="expenses-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-notes" class="view-section">
            <div class="card" style="max-width: 800px; margin: 0 auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3>üìù Savings Journal & Future Plans</h3>
                    <div style="font-size:12px; background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:5px;">
                        Funds Available: <span class="text-green">‚Çπ<span id="note-savings-display">0</span></span>
                    </div>
                </div>
                <p style="font-size:13px; opacity:0.7; margin-bottom:15px;">Use this space to plan big purchases, write down financial goals, or reflect on your monthly spending.</p>
                <textarea id="user-note" placeholder="E.g. I want to save ‚Çπ50,000 for a trip to Goa by December..."></textarea>
                <div style="text-align:right; margin-top:10px;">
                    <button class="primary" onclick="saveNote()" style="width:auto; padding:10px 30px;">Save Note</button>
                </div>
            </div>
        </div>

        <div id="view-comparison" class="view-section">
            <div class="card">
                <h3>üìà Monthly Trend Analysis</h3>
                <div class="advisor-box" style="background: rgba(255,255,255,0.05); border-left:4px solid #fff;">
                    <span class="advisor-icon">üìä</span>
                    <div id="comp-insight-text">Comparing current month to previous month performance.</div>
                </div>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>

        <div id="view-history" class="view-section">
            <div class="card">
                <h3>üìö Full History</h3>
                <p style="font-size:13px; opacity:0.8; margin-bottom:12px;">Browse cached or live history for the signed-in user. This will show live data when you're logged in.</p>
                <div style="display:flex; gap:8px; margin-bottom:12px;">
                    <input id="history-search" placeholder="Search history..." oninput="filterHistory()" style="flex:1">
                    <button class="secondary" onclick="clearCache()">Clear Cache</button>
                    <button class="secondary" onclick="exportToCSV()">Export CSV</button>
                </div>
                <div id="history-list" style="max-height:420px; overflow:auto;"></div>
            </div>
        </div>

    </div>
</div>

<footer>
     &copy; 2025 Expense & Savings Pro. Designed by 
    <a href="#" target="_blank">Nihar Reddnam</a> ‚Ä¢ 
    <a href="https://niharreddnam.vercel.app/" target="_blank">My Portfolio</a>
</footer>

<!-- Reference: original file used as base for modifications. -->
<!-- :contentReference[oaicite:1]{index=1} -->

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDTYIqJa8jKz9qaTvLoRQoVV77HvQw344k",
        authDomain: "realtimetypewriter.firebaseapp.com",
        databaseURL: "https://realtimetypewriter-default-rtdb.firebaseio.com",
        projectId: "realtimetypewriter",
        storageBucket: "realtimetypewriter.firebasestorage.app",
        messagingSenderId: "224119059013",
        appId: "1:224119059013:web:18650b540baea7c6f9692c",
        measurementId: "G-YP2K0YG0FY"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let userId = null;
    let doughnutChart = null;
    let barChart = null;
    let allExpensesData = []; 
    let isCachedView = false; // true when showing cached data
    let userUnsub = null;
    let itemsUnsub = null;

    function showToast(msg, type='info') {
        const t = document.createElement('div');
        t.className = `toast ${type}`; t.innerText = msg;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return '';
        return String(unsafe)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
    }

    /* ---------- Per-user cache helpers ---------- */
    // store cache under a user-specific key
    function cacheKeyFor(uid) {
        return `esp_cache_${uid}`;
    }

    function saveCacheToLocalForUser(expensesArr, income, note, uid) {
        if (!uid) return;
        try {
            const payload = {
                ts: Date.now(),
                income: income || 0,
                note: note || "",
                expenses: (expensesArr || []).map(it => ({
                    id: it.id || null,
                    desc: it.desc || '',
                    cat: it.cat || '',
                    amt: it.amt || 0,
                    dateObj: it.dateObj ? it.dateObj.toISOString() : new Date().toISOString(),
                    dateStr: it.dateStr || (new Date().toLocaleDateString('en-IN', {month:'short', day:'numeric'}))
                }))
            };
            localStorage.setItem(cacheKeyFor(uid), JSON.stringify(payload));
            // optional: keep a quick index of cached uids
            const idx = JSON.parse(localStorage.getItem('esp_cache_index') || "[]");
            if (!idx.includes(uid)) {
                idx.push(uid);
                localStorage.setItem('esp_cache_index', JSON.stringify(idx));
            }
        } catch (e) {
            console.warn("Cache save failed", e);
        }
    }

    function loadCacheForUser(uid) {
        if (!uid) return null;
        try {
            const raw = localStorage.getItem(cacheKeyFor(uid));
            if (!raw) return null;
            return JSON.parse(raw);
        } catch (e) {
            console.warn("Cache load failed", e);
            return null;
        }
    }

    function clearCacheForCurrentUser() {
        if (!userId) {
            // if no userId (logged out) but cached UI active, try to remove last-used cache key from UI input
            showToast("No active user to clear cache for", "error");
            return;
        }
        if (confirm("Clear cached history for this user? This cannot be undone.")) {
            localStorage.removeItem(cacheKeyFor(userId));
            // update index too
            const idx = JSON.parse(localStorage.getItem('esp_cache_index') || "[]").filter(x => x !== userId);
            localStorage.setItem('esp_cache_index', JSON.stringify(idx));
            allExpensesData = [];
            renderHistoryList([]);
            showToast("Cache cleared for this user", "success");
            if (isCachedView) {
                renderList([]);
                renderBudgets([], 0);
            }
        }
    }

    /* ---------- Auth handling + load cache on sign-in ---------- */
    auth.onAuthStateChanged(user => {
        console.log("onAuthStateChanged -> user:", user);
        // detach previous listeners if any
        if (typeof userUnsub === 'function') { userUnsub(); userUnsub = null; console.log("detached userUnsub"); }
        if (typeof itemsUnsub === 'function') { itemsUnsub(); itemsUnsub = null; console.log("detached itemsUnsub"); }

        const wrapper = document.getElementById('main-wrapper');
        const footer = document.querySelector('footer');
        if (user) {
            userId = user.uid;
            // First, try to render per-user cache immediately so user sees their previous data while live listeners attach
            const cached = loadCacheForUser(userId);
            if (cached) {
                // restore cached view quickly
                const income = cached.income || 0;
                const note = cached.note || "";
                const restored = (cached.expenses || []).map(item => {
                    const d = Object.assign({}, item);
                    d.dateObj = item.dateObj ? new Date(item.dateObj) : new Date();
                    d.dateStr = item.dateStr || (d.dateObj.toLocaleDateString('en-IN', {month:'short', day:'numeric'}));
                    return d;
                });
                allExpensesData = restored;
                document.getElementById('income').value = income;
                document.getElementById('user-note').value = note;
                renderList(allExpensesData);
                renderBudgets(allExpensesData, income);
                const cats = {};
                restored.forEach(d=> cats[d.cat] = (cats[d.cat]||0) + (d.amt||0));
                updateCharts(cats, restored.reduce((s,i)=> s + (i.amt||0), 0), 0);
                updateBadges(income, restored.reduce((s,i)=> s + (i.amt||0), 0), restored);
                updateAdvisor(income, restored.reduce((s,i)=> s + (i.amt||0), 0), cats);
                renderHistoryList(restored);
                isCachedView = true;
                document.getElementById('cache-banner').style.display = 'block';
                showToast("Loaded your cached data ‚Äî switching to live when available.", "info");
            } else {
                isCachedView = false;
                document.getElementById('cache-banner').style.display = 'none';
            }

            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.body.classList.remove('login-mode');
            wrapper.classList.remove('auth-mode');
            footer.style.position = 'relative';

            // Now attach live listeners which will update UI and overwrite cache quickly
            loadData();
        } else {
            console.log("Signed OUT");
            userId = null;
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('app-content').style.display = 'none';
            document.body.classList.add('login-mode');
            wrapper.classList.add('auth-mode');
            footer.style.position = 'fixed';
            footer.style.bottom = '10px';
        }
    });

    /* ---------- Auth actions ---------- */
    function signIn() {
        const e = document.getElementById('email').value, p = document.getElementById('password').value;
        if(!e||!p) return showToast("Enter details", 'error');
        auth.signInWithEmailAndPassword(e, p).catch(err => showToast(err.message, 'error'));
    }
    function signUp() {
        const e = document.getElementById('email').value, p = document.getElementById('password').value;
        if(!e||!p) return showToast("Enter details", 'error');
        auth.createUserWithEmailAndPassword(e, p).catch(err => showToast(err.message, 'error'));
    }
    function signOut() { 
        // detach listeners locally first
        if (typeof userUnsub === 'function') { userUnsub(); userUnsub = null; console.log("userUnsub detached on signOut"); }
        if (typeof itemsUnsub === 'function') { itemsUnsub(); itemsUnsub = null; console.log("itemsUnsub detached on signOut"); }

        auth.signOut().then(() => {
            // keep cache on disk (per-user) ‚Äî do not clear it
            isCachedView = false;
            document.getElementById('cache-banner').style.display = 'none';
            document.getElementById('app-content').style.display = 'none';
            document.getElementById('auth-section').style.display = 'block';
        }).catch(err => {
            console.error("signOut error", err);
            showToast("Error signing out", "error");
        });
    }

    /* ---------- CRUD actions ---------- */
    function updateIncome() {
        const val = parseFloat(document.getElementById('income').value);
        if(!userId) { showToast("Login to save income", "error"); return; }
        db.collection('users').doc(userId).set({income: val}, {merge:true}).then(()=>showToast("Income Saved!", "success"));
    }
    function addExpense() {
        if(!userId) { showToast("Login to add expense", "error"); return; }
        const desc = document.getElementById('desc').value;
        const cat = document.getElementById('category').value;
        const amt = parseFloat(document.getElementById('amount').value);
        if(!cat || !amt) return showToast("Invalid Entry", "error");
        db.collection('expenses').doc(userId).collection('items').add({
            desc: desc || cat, cat, amt, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            document.getElementById('desc').value = "";
            document.getElementById('amount').value = "";
            showToast("Added!", "success");
        }).catch(e => {
            console.error("addExpense error", e);
            showToast("Could not add expense", "error");
        });
    }
    function deleteExpense(id) {
        if(!userId) { showToast("Login to delete", "error"); return; }
        if(confirm("Delete item?")) db.collection('expenses').doc(userId).collection('items').doc(id).delete().catch(e=>{console.error(e); showToast("Delete failed","error")});
    }

    // Save note to Firestore and to per-user cache (note will also be saved by snapshot cache flow)
    function saveNote() {
        const note = document.getElementById('user-note').value;
        if(!userId) { showToast("Login to save note", "error"); return; }
        db.collection('users').doc(userId).set({note: note}, {merge:true}).then(()=>{
            // also save into local cache immediately for quick restore
            saveCacheToLocalForUser(allExpensesData, parseFloat(document.getElementById('income').value || 0), note, userId);
            showToast("Note Saved!", "success");
        }).catch(e => { console.error("saveNote error", e); showToast("Could not save note", "error"); });
    }

    function exportToCSV() {
        if(allExpensesData.length === 0) return showToast("No data", "error");
        let csv = "Date,Description,Category,Amount\n";
        allExpensesData.forEach(item => { csv += `${item.dateStr},${item.desc},${item.cat},${item.amt}\n`; });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "my_expenses.csv";
        link.click();
    }
    function filterExpenses() {
        const term = document.getElementById('search-bar').value.toLowerCase();
        const filtered = allExpensesData.filter(item => (item.desc||'').toLowerCase().includes(term) || (item.cat||'').toLowerCase().includes(term));
        renderList(filtered);
    }

    /* ---------- Cache button on login card ---------- */
    function showCachedFromAuthCard() {
        // If user is logged-in, use their uid; otherwise offer a small chooser: try last cached user
        if (auth.currentUser && auth.currentUser.uid) {
            const ok = loadCacheAndRenderForUser(auth.currentUser.uid, true);
            if (!ok) showToast("No cached data available for your account", "error");
            return;
        }
        // if not signed in, try to show most-recent cached user (from index)
        const idx = JSON.parse(localStorage.getItem('esp_cache_index') || "[]");
        if (idx.length === 0) { showToast("No cached users found", "error"); return; }
        // show the most recently cached user's data
        const lastUid = idx[idx.length - 1];
        const ok = loadCacheAndRenderForUser(lastUid, true);
        if (!ok) showToast("No cached data available", "error");
    }

    /* ---------- loadData: attaches snapshots and saves per-user cache ---------- */
    function loadData() {
        if (!userId) {
            console.warn("loadData called but userId is null ‚Äî skipping");
            return;
        }

        // detach old listeners if present
        if (typeof userUnsub === 'function') { userUnsub(); userUnsub = null; }
        if (typeof itemsUnsub === 'function') { itemsUnsub(); itemsUnsub = null; }

        // listen to user profile (income/note)
        userUnsub = db.collection('users').doc(userId).onSnapshot(doc => {
            const data = doc.data() || {};
            const inc = data.income || 0;
            const note = data.note || "";
            document.getElementById('income').value = inc;
            document.getElementById('user-note').value = note;
            if(allExpensesData.length > 0) renderBudgets(allExpensesData, inc);
            // also save cache using latest note
            try { saveCacheToLocalForUser(allExpensesData, inc, note, userId); } catch(e){console.warn(e);}
        }, err => {
            console.error("user doc snapshot error:", err);
            showToast("Error reading profile data", "error");
        });

        // listen to expenses items and keep unsub handle
        itemsUnsub = db.collection('expenses').doc(userId).collection('items').orderBy('createdAt', 'desc')
        .onSnapshot(snap => {
            allExpensesData = [];
            const now = new Date();
            const currMo = now.getMonth();
            const lastMo = new Date(now.getFullYear(), now.getMonth()-1, 1).getMonth();
            
            let thisMoTotal = 0, lastMoTotal = 0;
            let categories = {};

            snap.forEach(doc => {
                const d = doc.data();
                const amt = d.amt || 0;
                let date = d.createdAt?.toDate ? d.createdAt.toDate() : new Date();
                allExpensesData.push({ id: doc.id, ...d, dateObj: date, dateStr: date.toLocaleDateString('en-IN', {month:'short', day:'numeric'}) });

                if(date.getMonth() === currMo) {
                    thisMoTotal += amt;
                    categories[d.cat] = (categories[d.cat] || 0) + amt;
                }
                if(date.getMonth() === lastMo) lastMoTotal += amt;
            });

            const income = parseFloat(document.getElementById('income').value || 0);
            const savings = income - thisMoTotal;

            // UPDATE BIG STATS
            document.getElementById('big-spent').innerText = thisMoTotal.toLocaleString('en-IN');
            const saveEl = document.getElementById('big-savings');
            saveEl.innerText = savings.toLocaleString('en-IN');
            saveEl.style.color = savings >= 0 ? '#69f0ae' : '#ff8a80';
            
            // Update Note Page display
            const noteSavingsEl = document.getElementById('note-savings-display');
            if(noteSavingsEl) noteSavingsEl.innerText = savings.toLocaleString('en-IN');

            renderList(allExpensesData);
            updateCharts(categories, thisMoTotal, lastMoTotal);
            renderBudgets(allExpensesData, income);
            updateBadges(income, thisMoTotal, allExpensesData);
            updateAdvisor(income, thisMoTotal, categories);

            // save a local cache copy for offline viewing (include current note input)
            try {
                const currentNote = document.getElementById('user-note').value || "";
                saveCacheToLocalForUser(allExpensesData, income, currentNote, userId);
            } catch(e) { console.warn("cache save error", e); }
            renderHistoryList(allExpensesData);
        }, err => {
            console.error("items snapshot error:", err);
            showToast("Error reading expenses", "error");
        });
    }

    /* ---------- render helpers ---------- */
    function renderList(data) {
        const listDiv = document.getElementById('expenses-list');
        listDiv.innerHTML = "";
        data.forEach(item => {
            const el = document.createElement('div');
            el.className = 'expense-item';
            el.innerHTML = `<div><strong>${escapeHtml(item.desc)}</strong><span class="cat-badge">${escapeHtml(item.cat)}</span> <span style="opacity:0.5;font-size:10px">${item.dateStr}</span></div>
                            <div>‚Çπ${item.amt}<button onclick="deleteExpense('${item.id}')" style="background:none;border:none;color:red;cursor:pointer;margin-left:10px;">x</button></div>`;
            listDiv.appendChild(el);
        });
    }

    function renderHistoryList(data) {
        const listDiv = document.getElementById('history-list');
        if(!listDiv) return;
        listDiv.innerHTML = "";
        data.forEach(item => {
            const el = document.createElement('div');
            el.style = "background: rgba(255,255,255,0.03); padding: 10px; margin-bottom: 8px; border-radius: 8px; display:flex; justify-content:space-between; align-items:center;";
            el.innerHTML = `<div>
                <div style="font-weight:600">${escapeHtml(item.desc || item.cat)}</div>
                <div style="font-size:12px; opacity:0.7">${escapeHtml(item.cat)} ‚Ä¢ ${item.dateStr}</div>
            </div>
            <div style="font-weight:700">‚Çπ${item.amt}</div>`;
            listDiv.appendChild(el);
        });
    }

    function filterHistory() {
        const term = document.getElementById('history-search').value.toLowerCase();
        const filtered = allExpensesData.filter(item => (item.desc||'').toLowerCase().includes(term) || (item.cat||'').toLowerCase().includes(term));
        renderHistoryList(filtered);
    }

    function renderBudgets(data, income) {
        if(income === 0) return document.getElementById('budget-bars').innerHTML = "<div style='text-align:center;opacity:0.5;font-size:11px'>Set Income to see targets</div>";
        const currMo = new Date().getMonth();
        let catTotals = {};
        data.forEach(d => { if(d.dateObj.getMonth() === currMo) catTotals[d.cat] = (catTotals[d.cat] || 0) + d.amt; });
        
        const limits = { "Rent": 0.30, "Food": 0.15, "Transport": 0.10, "Shopping": 0.10, "Entertainment": 0.05, "Health": 0.05, "Others": 0.05 };
        let html = "";
        for (const [cat, total] of Object.entries(catTotals)) {
            const limitAmt = income * (limits[cat] || 0.10);
            const pct = Math.min((total / limitAmt) * 100, 100);
            let color = ""; if(pct > 100) color = "over"; else if(pct > 80) color = "warn";
            html += `<div class="budget-item"><div class="budget-header"><span>${escapeHtml(cat)}</span><span>‚Çπ${total} / ‚Çπ${limitAmt.toFixed(0)}</span></div>
                     <div class="progress-track"><div class="progress-fill ${color}" style="width: ${pct}%"></div></div></div>`;
        }
        document.getElementById('budget-bars').innerHTML = html || "<div style='text-align:center;opacity:0.5;font-size:11px'>No spending yet</div>";
    }

    function updateBadges(income, expense, data) {
        let badges = "";
        const savingsRate = income > 0 ? ((income - expense)/income)*100 : 0;
        if(savingsRate > 20) badges += `<span class="game-badge" title="Super Saver">üõ°Ô∏è</span>`;
        if(income > 100000) badges += `<span class="game-badge" title="High Earner">üëë</span>`;
        if(data.length >= 5) badges += `<span class="game-badge" title="Tracker">üìú</span>`;
        if(expense < (income * 0.5) && income > 0) badges += `<span class="game-badge" title="Frugal">üå±</span>`;
        document.getElementById('badge-case').innerHTML = badges;
    }

    function updateAdvisor(income, expense, cats) {
        const el = document.getElementById('ai-advice');
        if(income === 0) return el.innerText = "Set income to get AI insights.";
        const savings = income - expense;
        const food = cats['Food'] || 0;
        const rent = cats['Rent'] || 0;
        let msg = "Spending looks normal.";
        if(savings < 0) msg = "‚ö†Ô∏è You exceeded your income! Review 'Wants' immediately.";
        else if((food/income) > 0.20) msg = "üí° Spending >20% on Food. Try cooking more.";
        else if((rent/income) > 0.40) msg = "üè† Rent is high (>40%). Ideal is <30%.";
        else if(savings > (income*0.3)) msg = "üöÄ Saving >30%! Consider investing surplus.";
        el.innerText = msg;
    }

    function updateCharts(cats, curr, prev) {
        const ctxD = document.getElementById('expenseChart').getContext('2d');
        if(doughnutChart) doughnutChart.destroy();
        doughnutChart = new Chart(ctxD, {
            type: 'doughnut',
            data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: ['#00d2ff', '#3a7bd5', '#ff4757', '#2ecc71', '#f1c40f', '#9b59b6'], borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        const ctxB = document.getElementById('comparisonChart').getContext('2d');
        if(barChart) barChart.destroy();
        barChart = new Chart(ctxB, {
            type: 'bar',
            data: { labels: ['Last Month', 'This Month'], datasets: [{ label: 'Total', data: [prev, curr], backgroundColor: ['rgba(255, 255, 255, 0.2)', curr > prev ? '#ff4757' : '#00c853'], borderRadius: 8, barThickness: 50 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } }, x: { grid: { display: false }, ticks: { color: '#fff' } } }, plugins: { legend: { display: false } } }
        });
        
        const diff = curr - prev;
        const txt = prev === 0 ? "Not enough data yet." : (diff > 0 ? `Spent ‚Çπ${diff} more than last month.` : `Saved ‚Çπ${Math.abs(diff)} vs last month!`);
        document.getElementById('comp-insight-text').innerText = txt;
    }

    function switchTab(tabName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${tabName}`).classList.add('active');
        
        const btns = document.querySelectorAll('.nav-btn');
        if(tabName === 'dashboard') btns[0].classList.add('active');
        if(tabName === 'notes') btns[1].classList.add('active');
        if(tabName === 'comparison') btns[2].classList.add('active');
        if(tabName === 'history') btns[3].classList.add('active');
    }

    // Attempt no automatic cached show by default
    (function init() {})();
</script>
</body>
</html>
